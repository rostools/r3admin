---
title: "Admin tasks for the introduction course"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  eval = FALSE,
  collapse = TRUE,
  comment = "#>"
)
library(tidyverse)
library(ghclass)
devtools::load_all()
```

These are the constants used for later functions.

```{r constants}
course_date <- "2023-04-25"
course_type <- "r-cubed-intro"
org_gh_course_name <- "r-cubed-2023-04"
```

The `{ghclass}` package requires a GitHub PAT in order to work.

```{r, eval=FALSE}
# Set GitHub PAT
# gitcreds::gitcreds_set()
ghclass::github_set_token(gitcreds::gitcreds_get(use_cache = FALSE)$password)
```

# Pre-course admin tasks

## Creating the planning issue

There are several tasks that need to be done before hand for each
course, and this function below creates that on either GitHub or GitLab.

```{r, eval=FALSE}
admin_create_planning_issue(course_type, course_date, host = "gitlab")
```

## Fetch (and save) pre-survey responses

Any admin task that requires participant information, we need to first
get that information from the precourse survey.

```{r}
# TODO: How to get these authenticated? Run first and then build vignette?
googledrive::drive_auth()
googlesheets4::gs4_auth()
precourse <- fetch_precourse_intro() %>%
  filter(course_version == max(course_version))
```

## Who didn't finish survey

Check those who didn't finish the survey yet. Do need the official list
to compare with, which can be deleted after the course.

```{r, eval=FALSE}
participants <- check_who_not_finish_survey(
  precourse,
  readr::read_csv(here::here("_ignore/official-participant-list.csv"))
)
nrow(participants)
View(participants)
```

Then need to send a reminder email to those who didn't complete the
survey or tasks yet.

<!-- TODO: Create function to create an email directly? https://gmailr.r-lib.org/ -->

```{r, eval=FALSE}
copy_emails_for_reminder(participants)
copy_reminder_email_text()
```

## Basic setup checks

Quickly check whether everyone has their setups done correctly.

```{r, results='asis'}
cat(check_setup(precourse))
```

## Who has problems

List those who have problems and print their setups.

```{r, results='asis'}
problems <- precourse %>%
  check_precourse_problems()
```

### Description of the problems

```{r, results='asis'}
problems %>%
  check_problem_description() %>%
  cat()
```

### Setup of those with problems

<!-- TODO: Convert this in a way that it shows the setups and problems together? -->

```{r, results='asis'}
problems %>%
  check_setup() %>%
  cat()
```

### Copy names to address in first day

Copy the names of those who have problems so I can paste it to something
like Telegram so I know who to seek out on the first day.

```{r, eval=FALSE}
problems %>%
  dplyr::pull(full_name) %>%
  copy_names_with_problems()
```

## Create group names

Create some fun group names for the course. There is some manual action
here to select the names I think are interesting or funky. Make groups
with about 4 people per group.

```{r}
set.seed(54323)
group_names <- create_group_names()

# Use this number to determine how many groups to have.
ceiling(nrow(precourse) / 4)
group_names_final <- group_names[c(
  43, 4, 3, 65, 51, 68, 13
)]
group_names_final
```

### Assigning members to groups

Now we need to assign the learners to the groups.

```{r}
learners_in_groups <- assign_learners_to_groups(
  precourse,
  group_names_final
)
count(learners_in_groups, team)
# View(learners_in_groups)

# Manually change if need be.
# learners_in_groups <- edit(learners_in_groups)
```

Create a PDF file of the team names with members, so we can print the
file before the first day and put each sheet of paper with the team name
and members on each table.

```{r, eval=FALSE, results='hide'}
learners_in_groups %>% 
  select(team_name = team, team_members = full_name) %>% 
  teams_with_members_to_one_pdf()
```

## Creating the GitHub org and groups

Follow the instructions on the [ghclass
vignette](https://rundel.github.io/ghclass/articles/ghclass.html).
First, you need to create the organization manually. Use the value in
here as the name:

```{r}
# Name for organization.
org_gh_course_name
```

Check details of the organization and set permissions:

```{r, eval=FALSE}
# org_set_repo_permission(org_gh_course_name, permission = "none")
org_sitrep(org_gh_course_name)
```

Invite participants onto GitHub:

```{r, eval=FALSE}
# org_invite(org_gh_course_name, precourse$github_username)
org_members(org_gh_course_name)
org_pending(org_gh_course_name)
```

Then we can create the teams based on the group names:

```{r, eval=FALSE}
team_create(org_gh_course_name, group_names_final)
org_teams(org_gh_course_name)
```

Then assign the people to the teams.

```{r, eval=FALSE}
# Use this to remove users from teams, if you mess up.
# bind_rows(
#   team_members(org_gh_course_name),
#   team_pending(org_gh_course_name)
# ) %>% 
#   distinct() %>% 
#   pwalk(\(team, user) team_remove(org = org_gh_course_name, user = user, team = team, team_type = "slug"))
team_invite(
  org_gh_course_name,
  learners_in_groups$github_username,
  learners_in_groups$team
)
```

We need to create repos for each team.

```{r, eval=FALSE}
gh_repos <- repo_create(org_gh_course_name, group_names_final)
repo_add_team(sort(gh_repos), sort(unique(learners_in_groups$team)))
```

Make a table for the planning issue to put the instructors in groups.
There might be some manual tinkering here.

```{r, eval=FALSE}
instructors <- tibble::tribble(
  ~name, ~github_username,
  "Luke", "lwjohnst86",
  "Luke", "lwjohnst86",
  "Anders", "AndersAskeland",
  "Sara", "sarastinson",
  "Roger", "rmj822",
  "Malene", "MaleneRevsbech",
  "Evelina", "evelinastankevic",
)
instructors_to_groups <- assign_instructors_to_groups(group_names_final, instructors$name)
```

Then take instructors and assigned teams and convert them into a
Markdown table to paste into the planning issue.

```{r, eval=FALSE}
instructors_to_groups %>%
  copy_instructors_to_groups_table(org_gh_course_name)
```

Create a Helpers only team, so the team can be assigned to all the
repos.

```{r, eval=FALSE}
org_invite(org_gh_course_name, instructors$github_username)
team_create(org_gh_course_name, "Helpers")
team_invite(
  org_gh_course_name,
  instructors$github_username,
  "Helpers"
)
```

Add helpers and instructors team to all repos and set permissions to
admin.

```{r, eval=FALSE}
org_repos(org_gh_course_name) %>% 
  walk(~ {
    repo_team_permission(
      repo = .x,
      team = "Helpers",
      permission = "admin"
    )
  })
```

## Invite to Slack group

```{r, eval=FALSE}
copy_emails_for_slack_invite(precourse$email)
```

## Create projects to push to repos

Setting up the repos to have all the folders and files.

```{r, eval=FALSE}
setup_team_repos(org_gh_course_name)
```

```{r, eval=FALSE}
clone_team_repos(org_gh_course_name)
```

## Post course admin

Need to run these inside the project.

```{r, eval=FALSE}
```

